<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sort tests</title>
  <link rel="stylesheet" href="https://test.mavo.io/style.css" />
  <link rel="stylesheet" href="https://get.mavo.io/mavo.css" />
  <script src="https://get.mavo.io/mavo.js"></script>
</head>
<body>

<h1>Sort tests</h1>

<section>
	<h1>String and number sorts, expected use cases</h1>
	<table class="reftest" data-test="expressionEvaluation" data-columns="3">

		<!--Sort on empty array-->
		<tr title="Empty array">
			<td>sort([])</td>
			<td>[]</td>
		</tr>

		<!--Sort on numbers-->
		<tr title="Numbers">
			<td>sort([9, 4, 3, 5, 1, 2, 6, 0, 8, 7])</td>
			<td>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</td>
		</tr>

		<!--Sort on numbers with negative values-->
		<tr title="Mixed sign numbers">
			<td>sort([-10, 5, 3, -3, 10,  -2, 1, -7, 9, 7])</td>
			<td>[-10, -7, -3, -2, 1, 3, 5, 7, 9, 10]</td>
		</tr>

		<!--Sort on simple strings-->
		<tr title="Simple strings">
			<td>sort(['g', 'r', 'w', 'i', 's', 'a', 'h', 'o'])</td>
			<td>['a', 'g', 'h', 'i', 'o', 'r', 's', 'w']</td>
		</tr>

		<!--Sort on strings-->
		<tr title="Strings">
			<td>sort(['zaa', 'bcde', 'abc', 'bcda', 'bcd', 'aeb', 'abe', 'abcd'])</td>
			<td>['abc', 'abcd', 'abe', 'aeb', 'bcd', 'bcda', 'bcde', 'zaa']</td>
		</tr>

		<!--Sort on numbers with negative values, specifying +-->
		<tr title="Mixed sign numbers, + order specified">
			<td>sort([-10, 5, 3, -3, 10,  -2, 1, -7, 9, 7], '+')</td>
			<td>[-10, -7, -3, -2, 1, 3, 5, 7, 9, 10]</td>
		</tr>

		<!--Sort on strings, specifying +-->
		<tr title="Strings, + order specified">
			<td>sort(['zaa', 'bcde', 'abc', 'bcda', 'bcd', 'aeb', 'abe', 'abcd'], '+')</td>
			<td>['abc', 'abcd', 'abe', 'aeb', 'bcd', 'bcda', 'bcde', 'zaa']</td>
		</tr>

		<!--Reverse sort on numbers-->
		<tr title="Numbers, - order specified">
			<td>sort([-3, 2, -4, 1, 0, -2, -5, 5, 4, 3, -1], '-')</td>
			<td>[5, 4, 3, 2, 1, 0, -1, -2, -3, -4, -5]</td>
		</tr>

		<!--Reverse sort on strings-->
		<tr title="Strings, - order specified">
			<td>sort(['mnoz', 'zabc', 'za', 'b', 'z', 'zabcd', 'zab', 'a', 'mnoa', 'c', 'mnom'], '-')</td>
			<td>['zabcd', 'zabc', 'zab', 'za', 'z', 'mnoz', 'mnom', 'mnoa', 'c', 'b', 'a']</td>
		</tr>

	</table>
</section>

<section>
	<h1>String and number sorts, unexpected use cases</h1>
	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<!--Sort with invalid order param-->
		<!--TODO: go with default sort? Have sort fail?-->
		<tr title="Invalid order param">
			<td>sort(['zaa', 'bcde', 'abc', 'bcda', 'bcd', 'aeb', 'abe', 'abcd'], 'blah')</td>
			<td>['abc', 'abcd', 'abe', 'aeb', 'bcd', 'bcda', 'bcde', 'zaa']</td>
		</tr>

		<!--Sort with invalid order param, but valid order param later-->
		<!--TODO: go with first param that makes sense?-->
		<tr title="Invalid order param, but valid order param later">
			<td>sort(['zaa', 'bcde', 'abc', 'bcda', 'bcd', 'aeb', 'abe', 'abcd'], 'blah', '-')</td>
			<td>['zaa', 'bcde', 'bcda', 'bcd', 'aeb', 'abe', 'abcd', 'abc']</td>
		</tr>
		<!--Sort with invalid order param where property doesn't exist, but looks like they want decrease-->
		<!-- TODO: go with decrease? Stick with default sort (increase)? Have sort fail? -->
		<tr title="Invalid order param with order specified">
			<td>sort(['zaa', 'bcde', 'abc', 'bcda', 'bcd', 'aeb', 'abe', 'abcd'], '-blah')</td>
			<td>['zaa', 'bcde', 'bcda', 'bcd', 'aeb', 'abe', 'abcd', 'abc']</td>
		</tr>
		<!--TODO: same thing? even though + is in blah?-->
		<tr title="Invalid order param with order specified, valid order param later">
			<td>sort(['zaa', 'bcde', 'abc', 'bcda', 'bcd', 'aeb', 'abe', 'abcd'], '+blah', '-')</td>
			<td>['zaa', 'bcde', 'bcda', 'bcd', 'aeb', 'abe', 'abcd', 'abc']</td>
		</tr>


		<!--Sort on numbers with int order param-->
		<!--TODO: Use sign of number as sort criteria?-->
		<tr title="Number as order param">
			<td>sort([-3, 2, -4, 1, 0, -2, -5, 5, 4, 3, -1], -1)</td>
			<td>[5, 4, 3, 2, 1, 0, -1, -2, -3, -4, -5]</td>
		</tr>
		<tr>
			<td>sort([-3, 2, -4, 1, 0, -2, -5, 5, 4, 3, -1], 0)</td>
			<td>[-5,- 4, -3, -2, -1, 0, 1, 2, 3, 4, 5]</td>
		</tr>
		<tr>
			<td>sort([-3, 2, -4, 1, 0, -2, -5, 5, 4, 3, -1], 1)</td>
			<td>[-5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5]</td>
		</tr>
	</table>
</section>

<section>
	<h1>Object sort, expected use cases</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">

		<tr title="Simple objects, no property">
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			])</td>
			<td>[
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			]</td>
		</tr>

		<tr title="Simple objects, property no order">
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			], "prop1")</td>
			<td>[
				{"prop1": "a", "prop2": 3},
				{"prop1": "b", "prop2": 2},
				{"prop1": "c", "prop2": 1},
			]</td>
		</tr>
		<tr>
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			], "prop2")</td>
			<td>[
				{"prop1": "c", "prop2": 1},
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
			]</td>
		</tr>

		<tr title="Simple objects, property inc order">
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			], "+prop1")</td>
			<td>[
				{"prop1": "a", "prop2": 3},
				{"prop1": "b", "prop2": 2},
				{"prop1": "c", "prop2": 1},
			]</td>
		</tr>
		<tr>
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			], "+prop2")</td>
			<td>[
				{"prop1": "c", "prop2": 1},
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
			]</td>
		</tr>

		<tr title="Simple objects, property dec order">
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			], "-prop1")</td>
			<td>[
				{"prop1": "c", "prop2": 1},
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
			]</td>
		</tr>
		<tr>
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 3},
				{"prop1": "c", "prop2": 1},
			], "-prop2")</td>
			<td>[
				{"prop1": "a", "prop2": 3},
				{"prop1": "b", "prop2": 2},
				{"prop1": "c", "prop2": 1},
			]</td>
		</tr>

		<tr title="Simple objects, multiple properties">
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 2},
				{"prop1": "c", "prop2": 1},
				{"prop1": "d", "prop2": 1},
			], "prop2", "-prop1")</td>
			<td>[
				{"prop1": "d", "prop2": 1},
				{"prop1": "c", "prop2": 1},
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 2},
			]</td>
		</tr>
		<tr>
			<td>sort([
				{"prop1": "b", "prop2": 2},
				{"prop1": "a", "prop2": 2},
				{"prop1": "c", "prop2": 1},
				{"prop1": "d", "prop2": 1},
			], "-prop2", "+prop1")</td>
			<td>[
				{"prop1": "a", "prop2": 2},
				{"prop1": "b", "prop2": 2},
				{"prop1": "c", "prop2": 1},
				{"prop1": "d", "prop2": 1},
			]</td>
		</tr>

		<tr title="Deep objects, single property">
			<td>sort([
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
			], "+prop11.prop21.prop33")</td>
			<td>[
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
			]</td>
		</tr>

		<tr title="Deep objects, multiple properties">
			<td>sort([
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
			], "prop11.prop21.prop32", "-prop11.prop22")</td>
			<td>[
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
			]</td>
		</tr>
	</table>
</section>

<section>
	<h1>Object sort, unexpected use cases</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr title="No properties given">
			<td>sort([
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
			])</td>
			<td>[
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
			]</td>
		</tr>
		
		<tr title="Property that doesn't exist given, followed by property that does exist">
			<td>sort([
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
			], "-prop11.prop21.prop31.prop41", "+prop11.prop22")</td>
			<td>[
				{
					"prop11": {
						"prop21": {
							"prop31": 0,
							"prop32": 5,
							"prop33": "bca"
						},
						"prop22": -1
					},
				},
				{
					"prop11": {
						"prop21": {
							"prop31": -1,
							"prop32": 5,
							"prop33": "cba"
						},
						"prop22": 0
					}
				},
				{
					"prop11": {
						"prop21": {
							"prop31": 1,
							"prop32": 5,
							"prop33": "abc"
						},
						"prop22": 1
					}
				},
			]</td>
		</tr>
	</table>

</section>

<section>
	<h1>Other sort</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr title="Booleans">
			<td>sort([false, true, false, true])</td>
			<td>[false, false, true, true]</td>
		</tr>
		<tr>
			<td>sort([false, false, true, false], "-")</td>
			<td>[true, false, false, false]</td>
	</table>
</section>

<script src="mavo-sort.js"></script>

<script src="https://test.mavo.io/test.js"></script>
<script>
function getObjectArrayString(a) {
	s = '[\n';
	s += a.map((val) => {
		return JSON.stringify(val, null, ' ');
	}).join(',\n');
	s += '\n]';
	return s;
}
function expressionEvaluation(test, result, expected) {
  try {
    var r = (new Mavo.Expression(test.textContent)).eval({});
		if (r instanceof Array && r.length > 0 && typeof r[0] == 'object') {
			if (!(expected.childNodes.length > 0 && expected.childNodes[0].tagName)) {
				var expectedTextContent = expected.textContent;
				var code1 = document.createElement('code');
				var code2 = document.createElement('code');
				result.innerHTML = '';
				expected.innerHTML = '';
				result = result.appendChild(code1);
				expected = expected.appendChild(code2);

				result.textContent = getObjectArrayString(r);
				expected.textContent = getObjectArrayString(eval(expectedTextContent));
			}

			return Test.equals(JSON.stringify(r), JSON.stringify(eval(expected.textContent)));
		} else {
			result.textContent = JSON.stringify(r, null, 2);
			expected.textContent = JSON.stringify(eval(expected.textContent), null, 2);
			return Test.equals(r, eval(expected.textContent));
		}
  }
  catch(e) {
    console.error(e);
    result.textContent = "ERROR";
    return false;
  }
}
</script>
</body>
</html>

